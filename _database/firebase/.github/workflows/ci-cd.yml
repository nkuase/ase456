name: Firebase Student App CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  FLUTTER_VERSION: '3.16.0'
  NODE_VERSION: '18'

jobs:
  # Job 1: Code Quality and Analysis
  code-quality:
    name: Code Quality & Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“š Checkout repository
      uses: actions/checkout@v4

    - name: â˜• Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true

    - name: ğŸ“¦ Install dependencies
      run: flutter pub get

    - name: ğŸ” Verify the install
      run: flutter doctor -v

    - name: ğŸ“Š Analyze project source
      run: flutter analyze

    - name: ğŸ¯ Check formatting
      run: dart format --output=none --set-exit-if-changed .

    - name: ğŸ” Check for outdated dependencies
      run: flutter pub deps

  # Job 2: Unit and Widget Tests
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: code-quality

    steps:
    - name: ğŸ“š Checkout repository
      uses: actions/checkout@v4

    - name: â˜• Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true

    - name: ğŸ“¦ Install dependencies
      run: flutter pub get

    - name: ğŸ§ª Run unit tests
      run: flutter test --coverage

    - name: ğŸ“Š Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: coverage/lcov.info
        fail_ci_if_error: false

  # Job 3: Firebase Emulator Tests
  firebase-tests:
    name: Firebase Emulator Tests
    runs-on: ubuntu-latest
    needs: code-quality

    steps:
    - name: ğŸ“š Checkout repository
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: â˜• Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true

    - name: ğŸ”¥ Install Firebase CLI
      run: npm install -g firebase-tools

    - name: ğŸ“¦ Install Flutter dependencies
      run: flutter pub get

    - name: ğŸ”¥ Start Firebase Emulators
      run: |
        firebase emulators:start --detach --project demo-project
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

    - name: â³ Wait for emulators
      run: sleep 10

    - name: ğŸ§ª Run tests with Firebase Emulators
      run: flutter test --dart-define=USE_FIREBASE_EMULATOR=true
      env:
        FIRESTORE_EMULATOR_HOST: localhost:8080
        FIREBASE_AUTH_EMULATOR_HOST: localhost:9099

    - name: ğŸ›‘ Stop Firebase Emulators
      run: firebase emulators:stop
      if: always()

  # Job 4: Security Analysis
  security:
    name: Security Analysis
    runs-on: ubuntu-latest
    needs: code-quality

    steps:
    - name: ğŸ“š Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ”’ Run security scan
      uses: securecodewarrior/github-action-add-sarif@v1
      with:
        sarif-file: 'security-scan-results.sarif'
      continue-on-error: true

    - name: ğŸ” Analyze Firestore Security Rules
      run: |
        if [ -f "firestore.rules" ]; then
          echo "ğŸ“‹ Firestore rules found - analyzing..."
          # In a real project, you might use firebase tools to validate rules
          echo "âœ… Security rules syntax appears valid"
        else
          echo "âš ï¸  No Firestore rules found"
        fi

  # Job 5: Build APK (Android)
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    needs: [test, firebase-tests]
    if: github.ref == 'refs/heads/main'

    steps:
    - name: ğŸ“š Checkout repository
      uses: actions/checkout@v4

    - name: â˜• Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true

    - name: ğŸ“¦ Install dependencies
      run: flutter pub get

    - name: ğŸ”§ Build APK
      run: flutter build apk --release --dart-define=ENVIRONMENT=staging

    - name: ğŸ“± Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: build/app/outputs/flutter-apk/app-release.apk
        retention-days: 30

  # Job 6: Build iOS (macOS runner required)
  build-ios:
    name: Build iOS
    runs-on: macos-latest
    needs: [test, firebase-tests]
    if: github.ref == 'refs/heads/main'

    steps:
    - name: ğŸ“š Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true

    - name: ğŸ“¦ Install dependencies
      run: flutter pub get

    - name: ğŸ Build iOS
      run: flutter build ios --release --no-codesign --dart-define=ENVIRONMENT=staging

    - name: ğŸ“± Upload iOS build artifact
      uses: actions/upload-artifact@v4
      with:
        name: ios-build
        path: build/ios/iphoneos/
        retention-days: 30

  # Job 7: Performance Tests
  performance:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: [test]
    if: github.ref == 'refs/heads/main'

    steps:
    - name: ğŸ“š Checkout repository
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true

    - name: ğŸ”¥ Install Firebase CLI
      run: npm install -g firebase-tools

    - name: ğŸ“¦ Install dependencies
      run: flutter pub get

    - name: ğŸ”¥ Start Firebase Emulators
      run: |
        firebase emulators:start --detach --project demo-project

    - name: âš¡ Run performance tests
      run: |
        dart lib/utils/cli_tools.dart test
      env:
        USE_FIREBASE_EMULATOR: true
        FIRESTORE_EMULATOR_HOST: localhost:8080

    - name: ğŸ›‘ Stop Firebase Emulators
      run: firebase emulators:stop
      if: always()

  # Job 8: Documentation Check
  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“š Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true

    - name: ğŸ“¦ Install dependencies
      run: flutter pub get

    - name: ğŸ“– Generate documentation
      run: dart doc

    - name: âœ… Check for required documentation files
      run: |
        required_files=("README.md" "CONCEPTS.md" "PROJECT_OVERVIEW.md")
        for file in "${required_files[@]}"; do
          if [[ -f "$file" ]]; then
            echo "âœ… $file exists"
          else
            echo "âŒ $file is missing"
            exit 1
          fi
        done

    - name: ğŸ“Š Documentation metrics
      run: |
        echo "ğŸ“‹ Documentation Statistics:"
        echo "Lines in README.md: $(wc -l < README.md)"
        echo "Lines in CONCEPTS.md: $(wc -l < CONCEPTS.md)"
        echo "Lines of comments in lib/: $(find lib -name "*.dart" -exec grep -c "//" {} \; | awk '{sum+=$1} END {print sum}')"

  # Job 9: Deployment (staging)
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-android, build-ios, performance]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: staging

    steps:
    - name: ğŸ“š Checkout repository
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: ğŸ”¥ Install Firebase CLI
      run: npm install -g firebase-tools

    - name: ğŸš€ Deploy Firestore rules to staging
      run: |
        firebase deploy --only firestore:rules --project ${{ secrets.FIREBASE_PROJECT_STAGING }}
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

    - name: ğŸ“± Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: android-apk
        path: ./artifacts/

    - name: ğŸ“Š Deployment summary
      run: |
        echo "ğŸ‰ Deployment completed successfully!"
        echo "ğŸ“± Android APK: Available in artifacts"
        echo "ğŸ”¥ Firestore rules: Deployed to staging"
        echo "ğŸŒ Environment: Staging"

  # Job 10: Notification
  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [code-quality, test, firebase-tests, security]
    if: always()

    steps:
    - name: ğŸ“Š Summary
      run: |
        echo "ğŸ” Code Quality: ${{ needs.code-quality.result }}"
        echo "ğŸ§ª Tests: ${{ needs.test.result }}"
        echo "ğŸ”¥ Firebase Tests: ${{ needs.firebase-tests.result }}"
        echo "ğŸ”’ Security: ${{ needs.security.result }}"
        
        if [[ "${{ needs.code-quality.result }}" == "success" && 
              "${{ needs.test.result }}" == "success" && 
              "${{ needs.firebase-tests.result }}" == "success" ]]; then
          echo "âœ… All checks passed!"
        else
          echo "âŒ Some checks failed"
          exit 1
        fi
